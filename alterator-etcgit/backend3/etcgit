#!/bin/sh

alterator_api_version=1
po_domain="alterator-etcgit"

. alterator-sh-functions
. shell-config

get_branch_name() {
	(
		cd /etc
		git branch | sed -n -e 's/^\*[[:space:]]\+//p'
	)
}

list_branches() {
	(
		cd /etc
		git branch | sed -e 's/^\*\?[[:space:]]\+//'
	)
}

list_modified() {
	(
		cd /etc
		git status | sed -n -e 's/^#[[:space:]]\+modified:[[:space:]]\+//p'
	)
}

_list_K() {
        local rcd="$1"

        find "$rcd" -name 'K*' | \
        sed -e 's,^.*\(K[0-9]\+[^/]\+\)$,\1,' | \
	sort
}

_get_runlevel() {
        runlevel | sed -n 's/^.*\([0-9]\+\)$/\1/p'
}

_get_linked_srv() {
        local srv="$(readlink "$1")"

        echo "${srv##*/}"
}

list_kill_seq_for_srv() {
        local srvname="${1:-$in_service}"
        local runlevel=6
        local rcd="/etc/rc.d/rc$runlevel.d"
        [ -d "$rcd" ] || return 2

        for f in `_list_K "$rcd"`; do
                echo "$f"
                [ "$(_get_linked_srv "$f")" != "$srvname" ] || break
        done
}

_list_S() {
        local rcd="$1"

        find "$rcd" -name 'S*' | \
        sed -e 's,^.*\(S[0-9]\+[^/]\+\)$,\1,' | \
	sort
}

list_start_seq_for_srv() {
        local srvname="${1:-$in_service}"
        local runlevel="$(_get_runlevel)"
        [ -n "$runlevel" ] || runlevel=3
        local rcd="/etc/rc.d/rc$runlevel.d"
        [ -d "$rcd" ] || return 2

        for f in `_list_S "$rcd"`; do
                echo "$f"
                [ "$(_get_linked_srv "$f")" != "$srvname" ] || break
        done
}

_get_service_names_for_files() {
        rpm -qfl "$@" | \
        sed -n -e '/^\/etc\/init.d\/functions$/ d' \
               -e '/^\/etc\/rc.d\/init.d\/functions$/ d' \
               -e '/^\/etc\/init.d\/[^\/]\+$/ s/^.*\//p' \
               -e '/^\/etc\/rc.d\/init.d\/[^\/]\+$/ s/^.*\//p' | \
        uniq
}

_filter_SK() {
        sed -e 's/^[SK][0-9]\+//'
}

list_kill_seq() {
        for s in `_get_service_names_for_files `list_modified``; do
                list_kill_seq_for_srv "$s"
        done | \
        sort -u | \
        _filter_SK
}

list_start_seq() {
        for s in `_get_service_names_for_files `list_modified``; do
                list_start_seq_for_srv "$s"
        done | \
        sort -u | \
        _filter_SK
}

_duplicate() {
        sed -e 's/^.*$/&\t&/'
}

on_message()
{
	case "$in_action" in
		read)
			write_string_param 'branch' "$(get_branch_name)"
			;;
		list)
			case "$in__objects" in
				branches)
					list_branches | _duplicate | write_enum
					;;
                                start)
                                        if [ -n "${in_service:-}" ]; then
                                                list_start_seq_for_srv | _filter_SK | _duplicate | write_enum
                                        else
                                                list_start_seq | _duplicate | write_enum
                                        fi
                                        ;;
                                stop)
                                        if [ -n "${in_service:-}" ]; then
                                                list_kill_seq_for_srv | _filter_SK | _duplicate | write_enum
                                        else
                                                list_kill_seq | _duplicate | write_enum
                                        fi
                                        ;;
				*)
					list_modified | _duplicate | write_enum
					;;
			esac
			;;
	esac
}

message_loop
