#!/bin/sh

alterator_api_version=1
po_domain="alterator-etcgit"

. etcgit-sh-functions
. alterator-sh-functions

on_message()
{
	case "$in_action" in
		read)
			case "$in__objects" in
				/)
					write_string_param 'branch' "$(get_branch_name)"
					write_string_param 'url' "$(get_branch_remote_url)"
                                        if [ -n "$(_list_modified)" ]; then
                                                write_bool_param 'modified' 'yes'
                                        else
                                                write_bool_param 'modified' 'no'
                                        fi
					;;
				head)
                                        (
                                                hd="$(get_branch_head)"
                                                write_string_param 'commit' "$hd"
                                                write_string_param 'msg' "$(get_head_message "$hd")"
                                        )
					;;
				diff)
					write_string_param 'diff' "$(get_diff)"
					;;
			esac
			;;
		write)
			case "$in__objects" in
				/)
					${in_url+change_url}
					if [ -n "$in_branch" ]; then
						reset_to_branch
					fi
					;;
				head)
                                        if [ "$in_commit" = '#t' ]; then
                                                commit_tree && write_string_param 'commit' "$(get_branch_head)"
                                        else
                                                reload_head
                                        fi
					;;
			esac
			;;
		list)
			case "$in__objects" in
				branches)
					if [ -n "$in_url" ]; then
						list_remote_branches | _duplicate | write_enum
					fi
					;;
				commits)
					list_commits | (
                                                IFS='	'
                                                while read h t m s; do
                                                        write_table_item 'head' "$h" 'timestamp' "$t" 'msg' "$m" 'status' "$s"
                                                done
                                        )
					;;
                                start)
                                        if [ -n "${in_service:-}" ]; then
                                                list_start_seq_for_srv | _filter_SK | _duplicate | write_enum
                                        else
                                                list_start_seq | _duplicate | write_enum
                                        fi
                                        ;;
                                stop)
                                        if [ -n "${in_service:-}" ]; then
                                                list_kill_seq_for_srv | _filter_SK | _duplicate | write_enum
                                        else
                                                list_kill_seq | _duplicate | write_enum
                                        fi
                                        ;;
				/)
					_list_modified | _format_status | (
                                                IFS='	'
                                                while read n s; do
                                                        write_table_item 'filename' "$n" 'status' "$s"
                                                done
                                        )
					;;
			esac
			;;
	esac
}

message_loop
